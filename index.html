<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Salon Pro — Facturación & Citas</title>
  <meta name="theme-color" content="#0f0f12">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0f0f12; --fg:#ffffff; --muted:#a7a7b1;
      --primary:#6ee7b7; --primary-2:#22c55e; --accent:#93c5fd;
      --danger:#ef4444; --warn:#f59e0b; --card:#171821; --card-2:#1e202b;
      --topbar:#11121a; --footer:#0c0d12; --btn:#24263a; --outline:#2a2d40;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);-webkit-font-smoothing:antialiased}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:14px;height:64px;padding:0 16px;background:var(--topbar);border-bottom:1px solid var(--outline)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(145deg,var(--primary-2),var(--primary));display:inline-block}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .btn{background:var(--btn);color:var(--fg);border:1px solid var(--outline);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary-2);border-color:var(--primary-2);font-weight:700}

    /* Layout */
    .wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 64px)}
    .sidebar{border-right:1px solid var(--outline);background:var(--card);padding:16px}
    .nav{display:grid;gap:8px}
    .nav button{background:transparent;color:var(--fg);text-align:left;padding:10px 12px;border:1px solid transparent;border-radius:10px;cursor:pointer}
    .nav button.active,.nav button:hover{background:var(--card-2);border-color:var(--outline)}
    .content{padding:18px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 10px;font-size:18px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .field{display:grid;gap:6px}
    input,select,textarea{background:var(--card-2);color:var(--fg);border:1px solid var(--outline);padding:10px 12px;border-radius:10px;outline:none}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--outline)} th{text-align:left;color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi{background:var(--card);border:1px solid var(--outline);border-radius:12px;padding:14px;display:grid;gap:6px}
    .kpi .label{color:var(--muted);font-size:12px} .kpi .value{font-size:20px;font-weight:800}
    .footer{margin-top:auto;background:var(--footer);border-top:1px solid var(--outline);padding:12px 16px;color:var(--muted);text-align:center}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--outline);color:var(--muted)}
    .pill.ok{border-color:var(--primary-2);color:#d1ffe7}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}.sidebar{position:sticky;top:64px;z-index:1}.grid-2,.grid-3{grid-template-columns:1fr}.kpis{grid-template-columns:repeat(2,1fr)}}

    /* Login overlay */
    #login-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:100000}
    #login-card{width:min(420px,92vw);background:#11131a;color:#eaeaf7;border:1px solid #2a2f40;border-radius:14px;padding:20px;box-shadow:0 12px 36px rgba(0,0,0,.45);font:14px/1.4 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    #login-card h2{margin:0 0 10px;font-size:18px}
    #login-card .muted{color:#a7b0c0}
  </style>
</head>
<body>

  <!-- ===== LOGIN OVERLAY ===== -->
  <div id="login-overlay">
    <div id="login-card">
      <h2>Salón Pro — Iniciar sesión</h2>
      <p class="muted">Acceso administrativo</p>
      <div style="display:grid;gap:10px">
        <div>
          <label style="display:block;font-size:12px;color:#98a2b3;margin-bottom:6px;">Usuario</label>
          <input id="login-user" placeholder="admin" style="width:100%">
        </div>
        <div>
          <label style="display:block;font-size:12px;color:#98a2b3;margin-bottom:6px;">Contraseña</label>
          <input id="login-pass" type="password" placeholder="1234" style="width:100%">
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="login-btn" class="btn primary">Entrar</button>
          <span id="login-msg" style="color:#ef4444;font-size:12px;display:none">Credenciales inválidas</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ========= TOPBAR ========= -->
  <header class="topbar">
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <span>Salon Pro</span>
      <span class="pill ok">En línea</span>
    </div>
    <div class="top-actions">
      <button id="btnBackup" class="btn">Exportar backup</button>
      <input id="inputRestore" type="file" accept=".json" style="display:none"/>
      <button id="btnRestore" class="btn">Importar backup</button>
      <button id="btnClear" class="btn">Limpiar datos</button>
      <button id="btnLogout" class="btn">Cerrar sesión</button>
    </div>
  </header>

  <!-- ========= LAYOUT ========= -->
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar">
      <nav class="nav">
        <button class="active" data-screen="dashboard">Dashboard</button>
        <button data-screen="citas">Citas</button>
        <button data-screen="facturas">Facturas</button>
        <button data-screen="clientes">Clientes</button>
        <button data-screen="config">Configuración</button>
      </nav>
    </aside>

    <!-- Contenido -->
    <main class="content">
      <!-- ===== DASHBOARD ===== -->
      <section id="screen-dashboard" class="card">
        <h2>Dashboard</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Citas de hoy</div><div id="kpiCitasHoy" class="value">0</div></div>
          <div class="kpi"><div class="label">Facturas del mes</div><div id="kpiFacturasMes" class="value">$0.00</div></div>
          <div class="kpi"><div class="label">Clientes</div><div id="kpiClientes" class="value">0</div></div>
          <div class="kpi"><div class="label">Pendientes</div><div id="kpiPendientes" class="value">0</div></div>
        </div>
      </section>

      <!-- ===== CITAS ===== -->
      <section id="screen-citas" class="card" style="display:none">
        <h2>Citas</h2>
        <div class="grid-3">
          <div class="field"><label>Fecha</label><input type="date" id="citaFecha"></div>
          <div class="field"><label>Hora</label><input type="time" id="citaHora"></div>
          <div class="field"><label>Técnica / Empleado</label><input id="citaTecnica" placeholder="Ej: Cynthia"></div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div class="field"><label>Cliente</label><input id="citaCliente" placeholder="Nombre"></div>
          <div class="field"><label>Servicio</label><input id="citaServicio" placeholder="Gel tips"></div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div class="field"><label>Monto estimado ($)</label><input type="number" id="citaMonto" min="0" step="0.01" placeholder="0.00"></div>
          <div class="field"><label>Notas</label><input id="citaNotas" placeholder="Opcional"></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnCitaGuardar" class="btn primary">Guardar cita</button>
          <button id="btnCitaHoy" class="btn">Hoy</button>
          <button id="btnCitaLimpiar" class="btn">Limpiar</button>
        </div>
        <div class="card" style="margin-top:14px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <strong>Listado</strong>
            <span class="pill">localStorage</span>
            <div style="margin-left:auto;display:flex;gap:8px">
              <input id="filtroCitasTexto" placeholder="Buscar por cliente/técnica..."/>
              <button id="btnCitasExport" class="btn">Exportar CSV</button>
            </div>
          </div>
          <table id="tablaCitas"><thead><tr>
            <th>Fecha</th><th>Hora</th><th>Técnica</th><th>Cliente</th><th>Servicio</th><th>Total</th><th></th>
          </tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- ===== FACTURAS ===== -->
      <section id="screen-facturas" class="card" style="display:none">
        <h2>Facturas</h2>
        <div class="grid-3">
          <div class="field"><label>Fecha</label><input type="date" id="facFecha"></div>
          <div class="field"><label>Hora</label><input type="time" id="facHora"></div>
          <div class="field"><label>Técnica / Empleado</label><input id="facTecnica" placeholder="Ej: Cynthia"></div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div class="field"><label>Cliente</label><input id="facCliente" placeholder="Nombre"></div>
          <div class="field"><label>Monto total ($)</label><input type="number" id="facTotal" min="0" step="0.01" placeholder="0.00"></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnFacGuardar" class="btn primary">Guardar factura</button>
          <button id="btnFacHoy" class="btn">Hoy</button>
          <button id="btnFacLimpiar" class="btn">Limpiar</button>
        </div>
        <div class="card" style="margin-top:14px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <strong>Listado</strong>
            <span class="pill">localStorage</span>
            <div style="margin-left:auto;display:flex;gap:8px">
              <input id="filtroFacturasTexto" placeholder="Buscar por cliente/técnica..."/>
              <button id="btnFacturasExport" class="btn">Exportar CSV</button>
            </div>
          </div>
          <table id="tablaFacturas"><thead><tr>
            <th>Fecha</th><th>Hora</th><th>Técnica</th><th>Cliente</th><th>Total</th><th></th>
          </tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- ===== CLIENTES ===== -->
      <section id="screen-clientes" class="card" style="display:none">
        <h2>Clientes</h2>
        <div class="grid-3">
          <div class="field"><label>Nombre</label><input id="cliNombre" placeholder="Cliente"/></div>
          <div class="field"><label>Teléfono</label><input id="cliTelefono" placeholder="787-000-0000"/></div>
          <div class="field"><label>Email</label><input id="cliEmail" placeholder="correo@dominio.com"/></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnCliGuardar" class="btn primary">Guardar cliente</button>
          <button id="btnCliLimpiar" class="btn">Limpiar</button>
        </div>
        <div class="card" style="margin-top:14px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <strong>Directorio</strong>
            <div style="margin-left:auto;display:flex;gap:8px">
              <input id="filtroClientesTexto" placeholder="Buscar por nombre/teléfono..."/>
              <button id="btnClientesExport" class="btn">Exportar CSV</button>
            </div>
          </div>
          <table id="tablaClientes"><thead><tr><th>Nombre</th><th>Teléfono</th><th>Email</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- ===== CONFIG ===== -->
      <section id="screen-config" class="card" style="display:none">
        <h2>Configuración</h2>
        <div class="grid-2">
          <div class="field"><label>Nombre del negocio</label><input id="cfgNombre" placeholder="Cynthia’s Salón"/></div>
          <div class="field"><label>Color primario</label><input id="cfgColor" type="color" value="#22c55e"/></div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div class="field"><label>Técnicas / Empleados (coma)</label><input id="cfgTecnicas" placeholder="Cynthia, Laura, Ana"/></div>
          <div class="field"><label>WhatsApp</label><input id="cfgWhatsapp" placeholder="7876643079"/></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnCfgGuardar" class="btn primary">Guardar configuración</button>
          <button id="btnCfgReset" class="btn">Valores por defecto</button>
        </div>
      </section>
    </main>
  </div>

  <footer class="footer">Gracias por preferirnos — Todos los derechos reservados © Oasis Services PR</footer>

  <!-- ============== SCRIPT BASE (APP) ============== -->
  <script>
    /* ====== Sesión ====== */
    const SESSION_KEY='salonpro_session';
    const DEFAULT_USER='admin', DEFAULT_PASS='1234';
    function isLoggedIn(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY)||'{}').ok===true;}catch(_){return false;} }
    function setSession(ok){ localStorage.setItem(SESSION_KEY, JSON.stringify({ok,at:Date.now()})); }
    function showLogin(){
      document.querySelector('.topbar')?.setAttribute('style','display:none;');
      document.querySelector('.wrap')?.setAttribute('style','display:none;');
      document.querySelector('.footer')?.setAttribute('style','display:none;');
      document.getElementById('login-overlay').style.display='grid';
    }
    function hideLogin(){
      document.getElementById('login-overlay').style.display='none';
      document.querySelector('.topbar')?.setAttribute('style','');
      document.querySelector('.wrap')?.setAttribute('style','');
      document.querySelector('.footer')?.setAttribute('style','');
    }
    function attemptLogin(){
      const u=(document.getElementById('login-user').value||'').trim();
      const p=(document.getElementById('login-pass').value||'').trim();
      if(u===DEFAULT_USER && p===DEFAULT_PASS){
        setSession(true); hideLogin(); if(!window.__bootDone){ try{boot();}catch(_){} }
      }else{
        const msg=document.getElementById('login-msg'); msg.style.display='inline'; setTimeout(()=>msg.style.display='none',2000);
      }
    }
    function logout(){ setSession(false); showLogin(); }

    /* ====== Base App ====== */
    window.SALON_PRO={citas:[],facturas:[],clientes:[],config:{}};
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const fmtUSD=(n)=>`$${Number(n||0).toFixed(2)}`;
    const todayYMD=()=>new Date().toISOString().slice(0,10);
    const nowHM=()=>{const d=new Date();return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;};
    const LS_KEYS={citas:'salonpro_citas',facturas:'salonpro_facturas',clientes:'salonpro_clientes',config:'salonpro_config'};
    function loadLS(k,def){try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(_){return def;}}
    function saveLS(k,val){localStorage.setItem(k,JSON.stringify(val));}

    function bootState(){
      window.SALON_PRO.citas=loadLS(LS_KEYS.citas,[]);
      window.SALON_PRO.facturas=loadLS(LS_KEYS.facturas,[]);
      window.SALON_PRO.clientes=loadLS(LS_KEYS.clientes,[]);
      window.SALON_PRO.config=loadLS(LS_KEYS.config,{nombre:'Cynthia’s Salón',color:'#22c55e',tecnicas:['Cynthia','Laura','Ana'],whatsapp:'7876643079'});
      if(!window.SALON_PRO.citas.length){
        window.SALON_PRO.citas.push({id:crypto.randomUUID(),fecha:todayYMD(),hora:nowHM(),tecnica:'Cynthia',cliente:'Cliente demo',servicio:'Gel tips',total:45,notas:'—'});
        saveLS(LS_KEYS.citas,window.SALON_PRO.citas);
      }
      if(!window.SALON_PRO.facturas.length){
        window.SALON_PRO.facturas.push({id:crypto.randomUUID(),fecha:todayYMD(),hora:nowHM(),tecnica:'Cynthia',cliente:'Cliente demo',total:55});
        saveLS(LS_KEYS.facturas,window.SALON_PRO.facturas);
      }
      document.documentElement.style.setProperty('--primary-2',window.SALON_PRO.config.color);
    }

    function bindNav(){
      $$('.nav button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          $$('.nav button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
          const scr=btn.dataset.screen; $$('main .card[id^="screen-"]').forEach(sec=>sec.style.display='none');
          $('#screen-'+scr).style.display=''; if(scr==='dashboard') refreshKPIs();
        });
      });
    }

    function refreshKPIs(){
      const hoy=todayYMD();
      const citasHoy=window.SALON_PRO.citas.filter(x=>x.fecha===hoy).length;
      const mes=new Date().toISOString().slice(0,7);
      const factMes=window.SALON_PRO.facturas.filter(x=>(x.fecha||'').startsWith(mes)).reduce((s,x)=>s+Number(x.total||0),0);
      $('#kpiCitasHoy').textContent=String(citasHoy);
      $('#kpiFacturasMes').textContent=fmtUSD(factMes);
      $('#kpiClientes').textContent=String(window.SALON_PRO.clientes.length);
      $('#kpiPendientes').textContent='0';
    }

    function renderCitas(){
      const tb=$('#tablaCitas tbody'); tb.innerHTML='';
      const q=($('#filtroCitasTexto').value||'').toLowerCase();
      window.SALON_PRO.citas
        .filter(r=>{const h=`${r.cliente||''} ${r.tecnica||''} ${r.servicio||''}`.toLowerCase();return !q||h.includes(q);})
        .sort((a,b)=>(a.fecha+b.hora).localeCompare(b.fecha+b.hora))
        .forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.fecha||''}</td><td>${r.hora||''}</td><td>${r.tecnica||''}</td><td>${r.cliente||''}</td><td>${r.servicio||''}</td><td>${fmtUSD(r.total)}</td><td><button data-id="${r.id}" class="btn">Borrar</button></td>`;
          tb.appendChild(tr);
        });
      $$('#tablaCitas tbody .btn').forEach(b=>{
        b.addEventListener('click',()=>{const id=b.getAttribute('data-id');window.SALON_PRO.citas=window.SALON_PRO.citas.filter(x=>x.id!==id);saveLS(LS_KEYS.citas,window.SALON_PRO.citas);renderCitas();refreshKPIs();});
      });
    }

    function renderFacturas(){
      const tb=$('#tablaFacturas tbody'); tb.innerHTML='';
      const q=($('#filtroFacturasTexto').value||'').toLowerCase();
      window.SALON_PRO.facturas
        .filter(r=>{const h=`${r.cliente||''} ${r.tecnica||''}`.toLowerCase();return !q||h.includes(q);})
        .sort((a,b)=>(a.fecha+b.hora).localeCompare(b.fecha+b.hora))
        .forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.fecha||''}</td><td>${r.hora||''}</td><td>${r.tecnica||''}</td><td>${r.cliente||''}</td><td>${fmtUSD(r.total)}</td><td><button data-id="${r.id}" class="btn">Borrar</button></td>`;
          tb.appendChild(tr);
        });
      $$('#tablaFacturas tbody .btn').forEach(b=>{
        b.addEventListener('click',()=>{const id=b.getAttribute('data-id');window.SALON_PRO.facturas=window.SALON_PRO.facturas.filter(x=>x.id!==id);saveLS(LS_KEYS.facturas,window.SALON_PRO.facturas);renderFacturas();refreshKPIs();});
      });
    }

    function renderClientes(){
      const tb=$('#tablaClientes tbody'); tb.innerHTML='';
      const q=($('#filtroClientesTexto').value||'').toLowerCase();
      window.SALON_PRO.clientes
        .filter(r=>{const h=`${r.nombre||''} ${r.telefono||''}`.toLowerCase();return !q||h.includes(q);})
        .sort((a,b)=>(a.nombre||'').localeCompare(b.nombre||''))
        .forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.nombre||''}</td><td>${r.telefono||''}</td><td>${r.email||''}</td><td><button data-id="${r.id}" class="btn">Borrar</button></td>`;
          tb.appendChild(tr);
        });
      $$('#tablaClientes tbody .btn').forEach(b=>{
        b.addEventListener('click',()=>{const id=b.getAttribute('data-id');window.SALON_PRO.clientes=window.SALON_PRO.clientes.filter(x=>x.id!==id);saveLS(LS_KEYS.clientes,window.SALON_PRO.clientes);renderClientes();refreshKPIs();});
      });
    }

    function exportCSV(rows,filename){
      const csv=rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),500);
    }
  </script>
    <script>
    /* ===== Binders ===== */
    function bindCitas(){
      $('#btnCitaHoy').addEventListener('click',()=>{ $('#citaFecha').value=todayYMD(); $('#citaHora').value=nowHM(); });
      $('#btnCitaLimpiar').addEventListener('click',()=>{ $('#citaFecha').value='';$('#citaHora').value='';$('#citaTecnica').value='';$('#citaCliente').value='';$('#citaServicio').value='';$('#citaMonto').value='';$('#citaNotas').value=''; });
      $('#btnCitaGuardar').addEventListener('click',()=>{
        const r={id:crypto.randomUUID(),fecha:$('#citaFecha').value||todayYMD(),hora:$('#citaHora').value||nowHM(),tecnica:($('#citaTecnica').value||'').trim(),cliente:($('#citaCliente').value||'').trim(),servicio:($('#citaServicio').value||'').trim(),total:Number($('#citaMonto').value||0),notas:($('#citaNotas').value||'').trim()};
        window.SALON_PRO.citas.push(r); saveLS(LS_KEYS.citas,window.SALON_PRO.citas); renderCitas(); refreshKPIs(); alert('Cita guardada');
      });
      $('#filtroCitasTexto').addEventListener('input',renderCitas);
      $('#btnCitasExport').addEventListener('click',()=>{
        const rows=[['Fecha','Hora','Técnica','Cliente','Servicio','Total'],...window.SALON_PRO.citas.map(r=>[r.fecha,r.hora,r.tecnica,r.cliente,r.servicio,r.total])];
        exportCSV(rows,`citas_${Date.now()}.csv`);
      });
    }

    function bindFacturas(){
      $('#btnFacHoy').addEventListener('click',()=>{ $('#facFecha').value=todayYMD(); $('#facHora').value=nowHM(); });
      $('#btnFacLimpiar').addEventListener('click',()=>{ $('#facFecha').value='';$('#facHora').value='';$('#facTecnica').value='';$('#facCliente').value='';$('#facTotal').value=''; });
      $('#btnFacGuardar').addEventListener('click',()=>{
        const r={id:crypto.randomUUID(),fecha:$('#facFecha').value||todayYMD(),hora:$('#facHora').value||nowHM(),tecnica:($('#facTecnica').value||'').trim(),cliente:($('#facCliente').value||'').trim(),total:Number($('#facTotal').value||0)};
        window.SALON_PRO.facturas.push(r); saveLS(LS_KEYS.facturas,window.SALON_PRO.facturas); renderFacturas(); refreshKPIs(); alert('Factura guardada');
      });
      $('#filtroFacturasTexto').addEventListener('input',renderFacturas);
      $('#btnFacturasExport').addEventListener('click',()=>{
        const rows=[['Fecha','Hora','Técnica','Cliente','Total'],...window.SALON_PRO.facturas.map(r=>[r.fecha,r.hora,r.tecnica,r.cliente,r.total])];
        exportCSV(rows,`facturas_${Date.now()}.csv`);
      });
    }

    function bindClientes(){
      $('#btnCliLimpiar').addEventListener('click',()=>{ $('#cliNombre').value='';$('#cliTelefono').value='';$('#cliEmail').value=''; });
      $('#btnCliGuardar').addEventListener('click',()=>{
        const r={id:crypto.randomUUID(),nombre:($('#cliNombre').value||'').trim(),telefono:($('#cliTelefono').value||'').trim(),email:($('#cliEmail').value||'').trim()};
        window.SALON_PRO.clientes.push(r); saveLS(LS_KEYS.clientes,window.SALON_PRO.clientes); renderClientes(); refreshKPIs(); alert('Cliente guardado');
      });
      $('#filtroClientesTexto').addEventListener('input',renderClientes);
      $('#btnClientesExport').addEventListener('click',()=>{
        const rows=[['Nombre','Teléfono','Email'],...window.SALON_PRO.clientes.map(r=>[r.nombre,r.telefono,r.email])];
        exportCSV(rows,`clientes_${Date.now()}.csv`);
      });
    }

    function bindConfig(){
      const cfg=window.SALON_PRO.config;
      $('#cfgNombre').value=cfg.nombre||''; $('#cfgColor').value=cfg.color||'#22c55e';
      $('#cfgTecnicas').value=(cfg.tecnicas||[]).join(', '); $('#cfgWhatsapp').value=cfg.whatsapp||'';
      $('#btnCfgGuardar').addEventListener('click',()=>{
        const nuevo={nombre:$('#cfgNombre').value||'Cynthia’s Salón',color:$('#cfgColor').value||'#22c55e',tecnicas:($('#cfgTecnicas').value||'').split(',').map(s=>s.trim()).filter(Boolean),whatsapp:($('#cfgWhatsapp').value||'').trim()};
        window.SALON_PRO.config=nuevo; saveLS(LS_KEYS.config,nuevo);
        document.documentElement.style.setProperty('--primary-2',nuevo.color); alert('Configuración guardada');
      });
      $('#btnCfgReset').addEventListener('click',()=>{
        localStorage.removeItem(LS_KEYS.config); bootState(); bindConfig(); alert('Configuración restablecida');
      });
    }

    /* ===== Backup / Restore / Clear / Logout ===== */
    document.getElementById('btnBackup').addEventListener('click',()=>{
      const payload={citas:window.SALON_PRO.citas,facturas:window.SALON_PRO.facturas,clientes:window.SALON_PRO.clientes,config:window.SALON_PRO.config,exportedAt:new Date().toISOString()};
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`salonpro_backup_${Date.now()}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
    });
    document.getElementById('btnRestore').addEventListener('click',()=>document.getElementById('inputRestore').click());
    document.getElementById('inputRestore').addEventListener('change',async(e)=>{
      const file=e.target.files[0]; if(!file) return; const text=await file.text();
      try{
        const data=JSON.parse(text);
        if(data.citas){window.SALON_PRO.citas=data.citas;saveLS(LS_KEYS.citas,data.citas);}
        if(data.facturas){window.SALON_PRO.facturas=data.facturas;saveLS(LS_KEYS.facturas,data.facturas);}
        if(data.clientes){window.SALON_PRO.clientes=data.clientes;saveLS(LS_KEYS.clientes,data.clientes);}
        if(data.config){window.SALON_PRO.config=data.config;saveLS(LS_KEYS.config,data.config);}
        document.documentElement.style.setProperty('--primary-2',(window.SALON_PRO.config||{}).color||'#22c55e');
        renderCitas();renderFacturas();renderClientes();refreshKPIs();bindConfig(); alert('Backup restaurado');
      }catch{ alert('Archivo inválido'); }
      e.target.value='';
    });
    document.getElementById('btnClear').addEventListener('click',()=>{
      if(!confirm('¿Borrar todos los datos locales (citas/facturas/clientes)?')) return;
      localStorage.removeItem(LS_KEYS.citas); localStorage.removeItem(LS_KEYS.facturas); localStorage.removeItem(LS_KEYS.clientes);
      window.SALON_PRO.citas=[]; window.SALON_PRO.facturas=[]; window.SALON_PRO.clientes=[];
      renderCitas(); renderFacturas(); renderClientes(); refreshKPIs();
    });
    document.getElementById('btnLogout').addEventListener('click', logout);

    /* ===== Boot ===== */
    function boot(){
      if(window.__bootDone) return; window.__bootDone=true;
      bootState(); bindNav(); bindCitas(); bindFacturas(); bindClientes(); bindConfig();
      $('#citaFecha').value=todayYMD(); $('#facFecha').value=todayYMD();
      renderCitas(); renderFacturas(); renderClientes(); refreshKPIs();

      // Login events
      document.getElementById('login-btn').addEventListener('click',attemptLogin);
      const onKey=(e)=>{ if(e.key==='Enter') attemptLogin(); };
      document.getElementById('login-user').addEventListener('keydown',onKey);
      document.getElementById('login-pass').addEventListener('keydown',onKey);
    }

    // Control de inicio: solo si hay sesión; si no, mostrar login.
    window.addEventListener('DOMContentLoaded',()=>{
      if(isLoggedIn()){ hideLogin(); boot(); } else { showLogin(); }
    });
  </script>

  <!-- ======== BOTÓN FLOTANTE ADMIN ======== -->
  <button id="sp-admin-btn" aria-label="Panel administrativo" style="
    position:fixed; right:16px; bottom:16px; z-index:999999;
    border:none; border-radius:999px; padding:12px 16px;
    background:#22c55e; color:#fff; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.35);
    cursor:pointer;">Admin</button>

  <!-- ======== Carga del panel (usa tu salonpro-admin.js) ======== -->
  <script type="module">
    import { mountSalonProAdmin } from './salonpro-admin.js';
    const DataAdapter = {
      async getRegistros(){
        if (window.VisorCitas?.getRegistros) return await window.VisorCitas.getRegistros();
        if (window.SALON_PRO?.citas || window.SALON_PRO?.facturas){
          const c=(window.SALON_PRO.citas||[]).map(x=>({...x,tipo:'cita'}));
          const f=(window.SALON_PRO.facturas||[]).map(x=>({...x,tipo:'factura'}));
          return [...c,...f];
        }
        const fRaw=localStorage.getItem('salonpro_facturas')||'[]';
        const cRaw=localStorage.getItem('salonpro_citas')||'[]';
        const f=JSON.parse(fRaw).map(x=>({...x,tipo:'factura'}));
        const c=JSON.parse(cRaw).map(x=>({...x,tipo:'cita'}));
        return [...f,...c];
      }
    };
    document.getElementById('sp-admin-btn')?.addEventListener('click',()=>{ mountSalonProAdmin({ adapter: DataAdapter }); });
  </script>
</body>
</html>
